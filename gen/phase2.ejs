#!/bin/bash
set -e -v -o pipefail
shopt -s dotglob

export HOME=/home/runner

ln -s /usr/lib/chromium-browser/chromedriver /usr/local/bin

LANG_SETUPS=()

<% for ( let lang of languages ) { -%>
<% if ( lang.setup ) { -%>

LANG_SETUPS+=('<%= lang.id %>')
setup_<%= lang.id %>() {

echo Setup <%= lang.name %>
<% for ( let line of lang.setup ) { -%>
<%- undup(line) %>
<% } -%>

if [ -n "$(ls -A /home/runner)" ]; then
	echo Storing home for <%= lang.name %>
	mkdir -p /opt/homes/<%= lang.name %>
	cp -r /opt/homes/default/* /opt/homes/<%= lang.name %>
	mv -nt /opt/homes/<%= lang.name %>/ /home/runner/*
	ls -A /opt/homes/<%= lang.name %>
fi
}

<% } -%>
<% } -%>

for lang in "${LANG_SETUPS[@]}"; do setup_$lang & done; wait

cp -r /opt/homes/default/* /home/runner
chown runner:runner -R /home/runner
chown runner:runner -R /config

rm -rf /var/lib/apt/lists/*
rm /phase2.sh
